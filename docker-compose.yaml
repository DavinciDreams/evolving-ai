services:
  api:
    build: .
    # Container listens on PORT (default 8000)
    # Coolify: Traefik proxy routes to this automatically, no host port needed
    # Local dev: use docker-compose.override.yaml to publish ports
    expose:
      - "${PORT:-80}"
    environment:
      - PORT=${PORT:-80}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      # LLM Provider Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - ZAI_API_KEY=${ZAI_API_KEY}
      - DEFAULT_LLM_PROVIDER=${DEFAULT_LLM_PROVIDER:-openrouter}
      - DEFAULT_MODEL=${DEFAULT_MODEL:-nvidia/nemotron-3-nano-30b-a3b:free}
      - EVALUATION_MODEL=${EVALUATION_MODEL:-nvidia/nemotron-3-nano-30b-a3b:free}
      - TEMPERATURE=${TEMPERATURE:-0.7}
      - MAX_TOKENS=${MAX_TOKENS:-2048}

      # Tool Use
      - ENABLE_TOOL_USE=${ENABLE_TOOL_USE:-true}
      - MAX_TOOL_ITERATIONS=${MAX_TOOL_ITERATIONS:-15}
      - TOOL_SANDBOX_DIR=/app
      - TPMJS_API_KEY=${TPMJS_API_KEY}

      # E2B Sandbox (remote code execution)
      - E2B_API_KEY=${E2B_API_KEY}

      # Agent Scratchpad
      - SCRATCHPAD_DIR=/app/data/scratchpad

      # Memory Configuration (ChromaDB)
      - MEMORY_PERSIST_DIRECTORY=/app/data/memory_db
      - MEMORY_COLLECTION_NAME=${MEMORY_COLLECTION_NAME:-agent_memory}
      - MAX_MEMORY_ENTRIES=${MAX_MEMORY_ENTRIES:-10000}

      # GitHub Integration
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPO=${GITHUB_REPO}
      - GITHUB_BRANCH=${GITHUB_BRANCH:-main}
      - GITHUB_LOCAL_REPO_PATH=/app
      - GITHUB_REPO_URL=${GITHUB_REPO_URL}
      - ENABLE_SELF_MODIFICATION=${ENABLE_SELF_MODIFICATION:-true}
      - BACKUP_DIRECTORY=/app/data/backups
      - MAX_MODIFICATION_ATTEMPTS=${MAX_MODIFICATION_ATTEMPTS:-3}
      - REQUIRE_VALIDATION=${REQUIRE_VALIDATION:-true}

      # Knowledge Base Configuration
      - KNOWLEDGE_BASE_PATH=/app/data/knowledge_base
      - AUTO_UPDATE_KNOWLEDGE=${AUTO_UPDATE_KNOWLEDGE:-true}
      - KNOWLEDGE_SIMILARITY_THRESHOLD=${KNOWLEDGE_SIMILARITY_THRESHOLD:-0.8}

      # Discord Integration
      - DISCORD_ENABLED=${DISCORD_ENABLED:-false}
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
      - DISCORD_CHANNEL_IDS=${DISCORD_CHANNEL_IDS}
      - DISCORD_STATUS_CHANNEL_ID=${DISCORD_STATUS_CHANNEL_ID}
      - DISCORD_MENTION_REQUIRED=${DISCORD_MENTION_REQUIRED:-false}
      - DISCORD_MAX_MESSAGE_LENGTH=${DISCORD_MAX_MESSAGE_LENGTH:-2000}
      - DISCORD_TYPING_INDICATOR=${DISCORD_TYPING_INDICATOR:-true}
      - DISCORD_EMBED_RESPONSES=${DISCORD_EMBED_RESPONSES:-true}
      - DISCORD_COMMAND_PREFIX=${DISCORD_COMMAND_PREFIX}
      - DISCORD_RATE_LIMIT_MESSAGES=${DISCORD_RATE_LIMIT_MESSAGES:-10}
      - DISCORD_COOLDOWN_SECONDS=${DISCORD_COOLDOWN_SECONDS:-2}
      - DISCORD_STATUS_UPDATES_ENABLED=${DISCORD_STATUS_UPDATES_ENABLED:-true}
      - DISCORD_STATUS_ON_IMPROVEMENT=${DISCORD_STATUS_ON_IMPROVEMENT:-true}
      - DISCORD_STATUS_ON_KNOWLEDGE_UPDATE=${DISCORD_STATUS_ON_KNOWLEDGE_UPDATE:-true}
      - DISCORD_STATUS_ON_HIGH_QUALITY=${DISCORD_STATUS_ON_HIGH_QUALITY:-false}

      # Web Search
      - WEB_SEARCH_ENABLED=${WEB_SEARCH_ENABLED:-true}
      - WEB_SEARCH_DEFAULT_PROVIDER=${WEB_SEARCH_DEFAULT_PROVIDER:-duckduckgo}
      - WEB_SEARCH_MAX_RESULTS=${WEB_SEARCH_MAX_RESULTS:-5}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - SERPAPI_KEY=${SERPAPI_KEY}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE=/app/logs/agent.log

      # Evaluation
      - ENABLE_EVALUATION=${ENABLE_EVALUATION:-false}

    volumes:
      # Persistent data â€” survives redeployments
      # Coolify: deploy as "Docker Compose" to auto-detect these
      - type: volume
        source: memory-data
        target: /app/data/memory_db
      - type: volume
        source: knowledge-data
        target: /app/data/knowledge_base
      - type: volume
        source: backup-data
        target: /app/data/backups
      - type: volume
        source: persistent-data
        target: /app/data/persistent_data
      - type: volume
        source: scratchpad-data
        target: /app/data/scratchpad
      - type: volume
        source: app-logs
        target: /app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:${PORT:-80}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  memory-data:
    name: evolving-ai-memory
  knowledge-data:
    name: evolving-ai-knowledge
  backup-data:
    name: evolving-ai-backups
  persistent-data:
    name: evolving-ai-persistent
  scratchpad-data:
    name: evolving-ai-scratchpad
  app-logs:
    name: evolving-ai-logs
