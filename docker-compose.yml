version: '3.8'

services:
  api:
    build: .
    ports:
      - "8000:8000"
    environment:
      # LLM Provider Configuration
      # Default: ZAI with GLM-4.7
      # Anthropic: use claude-sonnet-4-5-20250929
      # OpenAI: use gpt-4 or gpt-4-turbo
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - ZAI_API_KEY=${ZAI_API_KEY}
      - DEFAULT_LLM_PROVIDER=${DEFAULT_LLM_PROVIDER:-zai}
      - DEFAULT_MODEL=${DEFAULT_MODEL:-glm-4.7}
      - EVALUATION_MODEL=${EVALUATION_MODEL:-glm-4.7}
      - TEMPERATURE=${TEMPERATURE:-0.7}
      - MAX_TOKENS=${MAX_TOKENS:-2048}

      # Memory Configuration (ChromaDB)
      - MEMORY_PERSIST_DIRECTORY=/app/data/memory_db
      - MEMORY_COLLECTION_NAME=${MEMORY_COLLECTION_NAME:-agent_memory}
      - MAX_MEMORY_ENTRIES=${MAX_MEMORY_ENTRIES:-10000}

      # GitHub Integration
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPO=${GITHUB_REPO}
      - GITHUB_BRANCH=${GITHUB_BRANCH:-main}
      - GITHUB_LOCAL_REPO_PATH=/app
      - GITHUB_REPO_URL=${GITHUB_REPO_URL}
      - ENABLE_SELF_MODIFICATION=${ENABLE_SELF_MODIFICATION:-false}
      - BACKUP_DIRECTORY=/app/data/backups
      - MAX_MODIFICATION_ATTEMPTS=${MAX_MODIFICATION_ATTEMPTS:-3}
      - REQUIRE_VALIDATION=${REQUIRE_VALIDATION:-true}

      # Knowledge Base Configuration
      - KNOWLEDGE_BASE_PATH=/app/data/knowledge_base
      - AUTO_UPDATE_KNOWLEDGE=${AUTO_UPDATE_KNOWLEDGE:-true}
      - KNOWLEDGE_SIMILARITY_THRESHOLD=${KNOWLEDGE_SIMILARITY_THRESHOLD:-0.8}

      # Discord Integration
      - DISCORD_ENABLED=${DISCORD_ENABLED:-false}
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
      - DISCORD_CHANNEL_IDS=${DISCORD_CHANNEL_IDS}
      - DISCORD_STATUS_CHANNEL_ID=${DISCORD_STATUS_CHANNEL_ID}
      - DISCORD_MENTION_REQUIRED=${DISCORD_MENTION_REQUIRED:-false}
      - DISCORD_MAX_MESSAGE_LENGTH=${DISCORD_MAX_MESSAGE_LENGTH:-2000}
      - DISCORD_TYPING_INDICATOR=${DISCORD_TYPING_INDICATOR:-true}
      - DISCORD_EMBED_RESPONSES=${DISCORD_EMBED_RESPONSES:-true}
      - DISCORD_COMMAND_PREFIX=${DISCORD_COMMAND_PREFIX}
      - DISCORD_RATE_LIMIT_MESSAGES=${DISCORD_RATE_LIMIT_MESSAGES:-10}
      - DISCORD_COOLDOWN_SECONDS=${DISCORD_COOLDOWN_SECONDS:-2}
      - DISCORD_STATUS_UPDATES_ENABLED=${DISCORD_STATUS_UPDATES_ENABLED:-true}
      - DISCORD_STATUS_ON_IMPROVEMENT=${DISCORD_STATUS_ON_IMPROVEMENT:-true}
      - DISCORD_STATUS_ON_KNOWLEDGE_UPDATE=${DISCORD_STATUS_ON_KNOWLEDGE_UPDATE:-true}
      - DISCORD_STATUS_ON_HIGH_QUALITY=${DISCORD_STATUS_ON_HIGH_QUALITY:-false}

      # Web Search
      - WEB_SEARCH_ENABLED=${WEB_SEARCH_ENABLED:-true}
      - WEB_SEARCH_DEFAULT_PROVIDER=${WEB_SEARCH_DEFAULT_PROVIDER:-duckduckgo}
      - WEB_SEARCH_MAX_RESULTS=${WEB_SEARCH_MAX_RESULTS:-5}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - SERPAPI_KEY=${SERPAPI_KEY}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE=/app/logs/agent.log

      # Evaluation
      - ENABLE_EVALUATION=${ENABLE_EVALUATION:-false}

    volumes:
      # Persistent data storage
      - memory-data:/app/data/memory_db
      - knowledge-data:/app/data/knowledge_base
      - backup-data:/app/data/backups
      - app-logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  memory-data:
    driver: local
  knowledge-data:
    driver: local
  backup-data:
    driver: local
  app-logs:
    driver: local
